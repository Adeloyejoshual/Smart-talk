<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Talk - Chat</title>
  <link rel="stylesheet" href="/styles/chat.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <header>
    <h1>Smart Talk</h1>
    <nav>
      <a href="/home.html">Home</a>
      <a href="/chat.html" class="active">Chat</a>
      <a href="/notifications.html">Notifications</a>
      <a href="/profile.html">Profile</a>
    </nav>
  </header>

  <main>
    <div class="chat-container">
      <div class="chat-header">
        <h2 id="chatWith">Chat with <span id="chatUsername">User</span></h2>
        <span id="typingIndicator"></span>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <form id="chatForm" class="chat-form">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" required />
        <button type="submit">Send</button>
      </form>
    </div>
  </main>

  <script>
    const socket = io();
    const chatMessages = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("messageInput");
    const typingIndicator = document.getElementById("typingIndicator");

    const urlParams = new URLSearchParams(window.location.search);
    const receiverId = urlParams.get("id");
    const chatUsername = urlParams.get("username");
    document.getElementById("chatUsername").textContent = chatUsername || "Unknown";

    const token = localStorage.getItem("token");

    let typingTimeout;

    socket.emit("joinPrivateRoom", receiverId);

    messageInput.addEventListener("input", () => {
      socket.emit("typing", { to: receiverId });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit("stopTyping", { to: receiverId });
      }, 1000);
    });

    socket.on("typing", (data) => {
      typingIndicator.textContent = "Typing...";
    });

    socket.on("stopTyping", () => {
      typingIndicator.textContent = "";
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (!message) return;

      socket.emit("privateMessage", { to: receiverId, message });
      appendMessage("You", message);
      messageInput.value = "";
    });

    socket.on("privateMessage", (data) => {
      appendMessage(chatUsername, data.message);
    });

    function appendMessage(sender, message) {
      const msg = document.createElement("div");
      msg.classList.add("message");
      msg.innerHTML = `<strong>${sender}:</strong> ${message}`;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Load past chat
    window.addEventListener("load", async () => {
      const res = await fetch(`/api/messages/${receiverId}`, {
        headers: { Authorization: token }
      });
      const data = await res.json();
      data.messages.forEach(msg => {
        appendMessage(msg.sender === receiverId ? chatUsername : "You", msg.text);
      });
    });
  </script>
</body>
</html>