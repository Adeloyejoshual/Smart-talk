<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Private Chat | SmartTalk</title>
  <link rel="stylesheet" href="/styles/chat.css">
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; padding: 0; }
    .chat-container { max-width: 600px; margin: auto; padding: 20px; }
    .messages { height: 400px; overflow-y: scroll; background: #1e1e1e; padding: 10px; border-radius: 10px; }
    .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; }
    .sent { background: #4a76a8; align-self: flex-end; color: white; }
    .received { background: #333; align-self: flex-start; }
    .input-group { display: flex; margin-top: 15px; }
    .input-group input { flex: 1; padding: 10px; border: none; border-radius: 8px; margin-right: 10px; }
    .input-group button { padding: 10px; border: none; background: #4a76a8; color: white; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="chat-container">
    <h2 id="chatWith">Chat</h2>
    <div class="messages" id="messages"></div>
    <div class="input-group">
      <input type="text" id="messageInput" placeholder="Type your message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const receiverEmail = params.get("to");
    const sender = localStorage.getItem("email");

    document.getElementById("chatWith").textContent = `Chat with ${receiverEmail}`;

    const messagesDiv = document.getElementById("messages");

    // Join a room for 2 users
    const roomId = [sender, receiverEmail].sort().join("-");
    socket.emit("join-private", roomId);

    socket.on("private-message", ({ sender, message }) => {
      displayMessage(message, sender === localStorage.getItem("email"));
    });

    function sendMessage() {
      const msgInput = document.getElementById("messageInput");
      const message = msgInput.value;
      if (!message.trim()) return;
      socket.emit("private-message", { roomId, message, sender });
      displayMessage(message, true);
      msgInput.value = '';
    }

    function displayMessage(message, isSender) {
      const div = document.createElement("div");
      div.className = `message ${isSender ? 'sent' : 'received'}`;
      div.textContent = message;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>