<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Group – SmartTalk</title>
  <link rel="stylesheet" href="styles/chat.css" />
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <button onclick="window.location.href='home.html'">← Back</button>
      <h2>Create New Group</h2>
    </div>

    <form id="groupForm" class="group-form">
      <input type="text" id="groupName" placeholder="Group Name" required />

      <div id="friendsList" class="friends-list"></div>

      <button type="submit">Create Group</button>
    </form>
  </div>

  <script type="module">
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    const groupForm = document.getElementById("groupForm");
    const groupName = document.getElementById("groupName");
    const friendsList = document.getElementById("friendsList");

    const headers = {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    };

    // Load all users (friends)
    fetch("/api/users/list", { headers })
      .then((res) => res.json())
      .then((users) => {
        users.forEach((user) => {
          const div = document.createElement("div");
          div.innerHTML = `
            <label>
              <input type="checkbox" value="${user._id}" />
              ${user.username} (${user.email})
            </label>
          `;
          friendsList.appendChild(div);
        });
      });

    // Submit group creation
    groupForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const selected = [...friendsList.querySelectorAll("input[type=checkbox]:checked")].map(
        (checkbox) => checkbox.value
      );

      if (!groupName.value.trim() || selected.length === 0) {
        return alert("Please enter a name and select at least one member.");
      }

      try {
        const res = await fetch("/api/groups/create", {
          method: "POST",
          headers,
          body: JSON.stringify({
            name: groupName.value.trim(),
            members: selected,
          }),
        });

        const data = await res.json();
        alert("Group created successfully!");
        window.location.href = `/group-chat.html?group=${data._id}`;
      } catch (err) {
        console.error(err);
        alert("Failed to create group.");
      }
    });
  </script>
</body>
</html>