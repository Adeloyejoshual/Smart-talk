<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chats</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .chat-list { list-style: none; padding: 0; margin: 0; }
    .chat-item {
      padding: 12px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    .chat-item:hover { background: #f9f9f9; }
    .name { font-weight: bold; }
    .last-msg { font-size: 14px; color: gray; }
  </style>
</head>
<body>
  <h2>Chats</h2>
  <ul class="chat-list" id="chatList"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const chatList = document.getElementById("chatList");

    // Listen to all chats
    const q = query(collection(db, "chats"), orderBy("lastUpdated", "desc"));
    onSnapshot(q, async (snapshot) => {
      chatList.innerHTML = "";
      for (const docSnap of snapshot.docs) {
        const chat = docSnap.data();

        // Lookup last message sender name
        let senderName = "Unknown";
        if (chat.lastSenderId) {
          const userRef = doc(db, "users", chat.lastSenderId);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            senderName = userSnap.data().fullName;
          }
        }

        const li = document.createElement("li");
        li.className = "chat-item";
        li.onclick = () => {
          window.location.href = `/public/messages.html?chatId=${docSnap.id}`;
        };
        li.innerHTML = `
          <div>
            <div class="name">${chat.name || "Unnamed Chat"}</div>
            <div class="last-msg">${senderName}: ${chat.lastMessage || ""}</div>
          </div>
          <div class="time">${chat.lastTime || ""}</div>
        `;
        chatList.appendChild(li);
      }
    });
  </script>
</body>
</html>