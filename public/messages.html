<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messages</title>
</head>
<body>
  <!-- üîπ Header -->
  <div id="topBar">
    <button id="backBtn">‚Üê</button>
    <img id="chatPhoto" src="https://via.placeholder.com/40">
    <span id="chatName">Loading...</span>
    <button id="menuBtn">‚ãÆ</button>
  </div>

  <!-- üîπ Messages -->
  <div id="messages"></div>

  <!-- üîπ Input -->
  <div id="inputBar">
    <input id="msgInput" type="text" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
  </div>

  <style>
    body { margin:0; font-family:sans-serif; }
    #topBar {
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px; background: #f8f8f8; border-bottom: 1px solid #ddd;
    }
    #topBar img { width: 40px; height: 40px; border-radius: 50%; margin: 0 8px; }
    #topBar span { flex: 1; font-weight: bold; }
    #topBar button { background: none; border: none; font-size: 20px; cursor: pointer; }

    #messages { padding: 10px; height: 70vh; overflow-y: auto; background: #fafafa; }
    .msg { max-width: 60%; padding: 8px 12px; margin: 6px 0; border-radius: 15px; word-wrap: break-word; }
    .me { background: #d1ffd1; margin-left: auto; text-align: right; }
    .other { background: #f1f1f1; margin-right: auto; text-align: left; }

    #inputBar { display: flex; padding: 10px; border-top: 1px solid #ddd; background: #fff; }
    #msgInput { flex: 1; padding: 8px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const chatNameEl = document.getElementById("chatName");
    const chatPhotoEl = document.getElementById("chatPhoto");

    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get("chatId");

    let currentUserId = null;
    let blockedUsers = [];

    // Back ‚Üí chat list
    document.getElementById("backBtn").onclick = () => {
      window.location.href = "/public/chat.html";
    };

    // Settings ‚Üí message settings
    document.getElementById("menuBtn").onclick = () => {
      window.location.href = `/public/messageSettings.html?chatId=${chatId}`;
    };

    // Auth + load user
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/public/auth.html";
        return;
      }
      currentUserId = user.uid;

      // Load blocked users
      const userSnap = await getDoc(doc(db, "users", currentUserId));
      if (userSnap.exists()) {
        blockedUsers = userSnap.data().blockedUsers || [];
      }

      // Load chat
      const chatRef = doc(db, "chats", chatId);
      const chatSnap = await getDoc(chatRef);

      if (chatSnap.exists()) {
        const chatData = chatSnap.data();

        if (chatData.type === "private") {
          const otherId = chatData.members.find(id => id !== currentUserId);
          if (otherId) {
            const userRef = doc(db, "users", otherId);
            const otherSnap = await getDoc(userRef);
            if (otherSnap.exists()) {
              const otherData = otherSnap.data();
              chatNameEl.innerText = otherData.fullName;
              if (otherData.photoURL) chatPhotoEl.src = otherData.photoURL;
            }
          }
        } else {
          chatNameEl.innerText = chatData.name || "Group Chat";
          if (chatData.photoURL) chatPhotoEl.src = chatData.photoURL;
        }
      }

      // Listen messages
      const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp"));
      onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();

          // Skip if sender is blocked
          if (blockedUsers.includes(msg.senderId)) return;

          const div = document.createElement("div");
          div.className = "msg " + (msg.senderId === currentUserId ? "me" : "other");
          div.innerText = msg.text;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    });

    // Send message
    window.sendMessage = async () => {
      if (!currentUserId) return;
      const text = msgInput.value.trim();
      if (!text) return;

      await addDoc(collection(db, "chats", chatId, "messages"), {
        senderId: currentUserId,
        text,
        timestamp: serverTimestamp()
      });

      msgInput.value = "";
    };
  </script>
</body>
</html>