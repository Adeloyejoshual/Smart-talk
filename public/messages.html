<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Messages</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    .msg { margin: 5px 0; padding: 8px; border-radius: 6px; max-width: 70%; }
    .me { background: #DCF8C6; margin-left: auto; }
    .other { background: #eee; margin-right: auto; }
    #inputBar { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    #msgInput { flex: 1; padding: 8px; }
  </style>
</head>
<body>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" type="text" placeholder="Type a message" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get chatId
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get("chatId") || "demo";

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");

    // Simulated logged-in user (later from Firebase Auth)
    const currentUserId = "user123";

    // Listen to messages in realtime
    const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp"));
    onSnapshot(q, async (snapshot) => {
      messagesDiv.innerHTML = "";
      for (const docSnap of snapshot.docs) {
        const msg = docSnap.data();

        // Fetch sender full name
        let senderName = "Unknown";
        if (msg.senderId) {
          const userRef = doc(db, "users", msg.senderId);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            senderName = userSnap.data().fullName;
          }
        }

        const div = document.createElement("div");
        div.className = "msg " + (msg.senderId === currentUserId ? "me" : "other");
        div.innerText = `${senderName}: ${msg.text}`;
        messagesDiv.appendChild(div);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Send message
    window.sendMessage = async () => {
      const text = msgInput.value.trim();
      if (!text) return;

      await addDoc(collection(db, "chats", chatId, "messages"), {
        senderId: currentUserId,
        text,
        timestamp: serverTimestamp()
      });

      msgInput.value = "";
    };
  </script>
</body>
</html>