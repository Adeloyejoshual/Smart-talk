<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartTalk - Home</title>
  <link rel="stylesheet" href="/styles/home.css" />
</head>
<body class="dark-mode">
  <header>
    <h1>SmartTalk</h1>
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="Search users by username or email" />
      <button onclick="searchUsers()">Search</button>
      <button id="addUserBtn">+</button>
      <button id="settingsBtn">⚙️</button>
    </div>
  </header>

  <main>
    <div id="userList"></div>
  </main>

  <!-- Modal for Add New User -->
  <div id="newUserModal" class="modal hidden">
    <div class="modal-content">
      <h2>Add New User</h2>
      <input type="text" id="modalSearchInput" placeholder="Search by username or email" oninput="liveSearchUsers()"/>
      <ul id="searchResults"></ul>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const isDark = localStorage.getItem("darkMode") === "true";
      document.body.classList.toggle("dark-mode", isDark);
      loadUsers();
    });

    document.getElementById('addUserBtn').addEventListener('click', () => {
      document.getElementById('newUserModal').classList.remove('hidden');
    });

    document.getElementById('newUserModal').addEventListener('click', (e) => {
      if (e.target.id === 'newUserModal') closeModal();
    });

    function closeModal() {
      document.getElementById('newUserModal').classList.add('hidden');
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('modalSearchInput').value = '';
    }

    async function searchUsers() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
      const users = await response.json();
      renderUsers(users, 'Search Results');
    }

    async function liveSearchUsers() {
      const query = document.getElementById('modalSearchInput').value.trim();
      const resultsList = document.getElementById('searchResults');
      resultsList.innerHTML = '';

      if (!query) return;

      const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
      const users = await res.json();

      if (users.length === 0) {
        resultsList.innerHTML = '<li>No users found</li>';
      } else {
        users.forEach(user => {
          const li = document.createElement('li');
          li.textContent = `${user.username} (${user.email})`;
          li.onclick = () => {
            closeModal();
            window.location.href = `chat.html?userId=${user._id}&username=${encodeURIComponent(user.username)}`;
          };
          resultsList.appendChild(li);
        });
      }
    }

    async function loadUsers() {
      try {
        const res = await fetch('/api/users/online');
        const users = await res.json();
        renderUsers(users, 'Online Users');
      } catch {
        const fallbackRes = await fetch('/api/users');
        const fallbackUsers = await fallbackRes.json();
        renderUsers(fallbackUsers, 'All Users');
      }
    }

    function renderUsers(users, title) {
      const list = document.getElementById('userList');
      list.innerHTML = `<h2>${title}</h2>` +
        users.map(u => `
          <div class="user">
            <img src="/avatars/${u.avatar || 'default.png'}" alt="Avatar">
            <div class="info">
              <div><strong>${u.username}</strong></div>
              <div>${u.email}</div>
            </div>
            <button class="chat-btn" onclick="window.location.href='chat.html?userId=${u._id}&username=${encodeURIComponent(u.username)}'">Chat</button>
          </div>
        `).join('');
    }
  </script>
</body>
</html>