<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartTalk - Home</title>
  <link rel="stylesheet" href="/styles/home.css" />
  <script src="/socket.io/socket.io.js" defer></script>
  <script defer>
    const socket = io();
    let selectedUserId = null;

    // Load logged-in user's name
    fetch("/api/users/me")
      .then(res => res.json())
      .then(data => {
        document.getElementById("usernameDisplay").textContent = data.username;
      });

    function searchUsers() {
      const query = document.getElementById("searchInput").value.trim();
      const results = document.getElementById("searchResults");
      results.innerHTML = "";

      if (!query) return;

      fetch(`/api/users/search?q=${query}`)
        .then(res => res.json())
        .then(users => {
          if (users.length === 0) {
            results.innerHTML = "<p>No users found.</p>";
            selectedUserId = null;
            return;
          }

          // Show first match and store ID
          const user = users[0];
          selectedUserId = user._id;

          const card = document.createElement("div");
          card.className = "user-card";
          card.innerHTML = `
            <strong>@${user.username}</strong>
            <p>${user.email}</p>
          `;
          results.appendChild(card);
        });
    }

    function addFriend() {
      if (!selectedUserId) return alert("Search and select a user first.");

      fetch(`/api/users/add-friend`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + localStorage.getItem("token") // Make sure token is saved on login
  },
  body: JSON.stringify({ userId: selectedUserId })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Friend request sent.");
        document.getElementById("searchResults").innerHTML = "";
        document.getElementById("searchInput").value = "";
        selectedUserId = null;
      });
    }
  </script>
</head>
<body>
  <header>
    <h1>Welcome, <span id="usernameDisplay">...</span></h1>
    <nav>
      <a href="/home.html">Home</a>
      <a href="/chat.html">Chat</a>
      <a href="/notifications.html">Notifications</a>
      <a href="/profile.html">Profile</a>
      <button onclick="location.href='/logout'">Logout</button>
    </nav>
  </header>

  <main>
    <section class="search-section">
      <h2>üîç Find User</h2>
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Enter username or email" />
        <button onclick="searchUsers()">üîç</button>
        <button onclick="addFriend()">Add Friend</button>
      </div>
      <div id="searchResults"></div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Smart Talk</p>
  </footer>
</body>
</html>