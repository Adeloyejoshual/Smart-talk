<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartTalk - Private Chat</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#1c1c1c;color:#fff;display:flex;flex-direction:column;height:100vh}
header{background:#111;padding:10px;text-align:center;position:sticky;top:0;z-index:10}
header h2{margin:0;font-size:20px}
#onlineStatus{font-size:12px;color:#0f0}
#chatBox{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column}
ul#messageList{list-style:none;padding:0;margin:0}
.day-separator{text-align:center;margin:10px 0;font-size:12px;opacity:.6}
.message{max-width:70%;margin:5px 0;padding:8px 12px;border-radius:15px;word-wrap:break-word;display:inline-block;position:relative}
.sent{background:#0b93f6;color:#fff;align-self:flex-end;border-bottom-right-radius:0}
.received{background:#e5e5ea;color:#000;align-self:flex-start;border-bottom-left-radius:0}
.timestamp{font-size:10px;opacity:.6;margin-top:2px;text-align:right}
#messageForm{display:flex;padding:10px;background:#111;position:sticky;bottom:0;z-index:10}
#messageInput{flex:1;padding:8px;border-radius:10px;border:none;margin-right:5px}
#sendBtn{padding:8px 12px;border:none;border-radius:10px;background:#0b93f6;color:#fff;cursor:pointer}
input[type=file]{display:none}
.file-btn,.image-btn{margin-right:5px;cursor:pointer;padding:6px 8px;border-radius:10px;background:#333;font-size:14px}
.typing{font-size:12px;font-style:italic;opacity:.6;margin-left:5px}
.message img{max-width:150px;margin-top:5px;border-radius:10px;cursor:pointer}
.message a{color:#0b93f6;text-decoration:underline;display:block;margin-top:5px}
#imageModal{display:none;position:fixed;z-index:50;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.9);justify-content:center;align-items:center}
#imageModal img{max-width:90%;max-height:90%;border-radius:10px}
#imageModal span{position:absolute;top:20px;right:30px;color:#fff;font-size:30px;font-weight:bold;cursor:pointer}
</style>
</head>
<body>
<header>
  <h2 id="username">Chat</h2>
  <div id="onlineStatus">Offline</div>
</header>

<div id="chatBox"><ul id="messageList"></ul></div>

<form id="messageForm">
  <label class="image-btn" for="imageInput">ðŸ“·</label>
  <input type="file" id="imageInput" accept="image/*" multiple>
  <label class="file-btn" for="fileInput">ðŸ“Ž</label>
  <input type="file" id="fileInput">
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button type="submit" id="sendBtn">Send</button>
</form>

<div id="imageModal"><span id="closeModal">&times;</span><img id="modalImg"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io({ auth: { token: localStorage.getItem("token") } });
  const urlParams = new URLSearchParams(window.location.search);
  const receiverId = urlParams.get("user");
  const receiverName = urlParams.get("name") || "Chat";

  const messageList = document.getElementById("messageList");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  const fileInput = document.getElementById("fileInput");
  const usernameEl = document.getElementById("username");
  const onlineStatusEl = document.getElementById("onlineStatus");
  const imageModal = document.getElementById("imageModal");
  const modalImg = document.getElementById("modalImg");
  const closeModal = document.getElementById("closeModal");

  if (!receiverId) window.location.href = "/home";

  let myUserId = null;
  let lastDateStr = "";

  function parseToken(token) {
    try { return JSON.parse(atob(token.split(".")[1])); } catch { return null; }
  }

  const token = localStorage.getItem("token");
  const decoded = parseToken(token);
  if (!decoded) window.location.href = "/login";
  myUserId = decoded.id;
  usernameEl.textContent = receiverName;

  socket.emit("joinPrivateRoom", { sender: myUserId, receiverId });

  // ---------- TYPING ----------
  let typingTimeout;
  messageInput.addEventListener("input", () => {
    socket.emit("typing", { to: receiverId });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => socket.emit("stop typing", { to: receiverId }), 1500);
  });

  socket.on("typing", () => {
    if (!document.getElementById("typing")) {
      const li = document.createElement("li");
      li.id = "typing";
      li.className = "typing";
      li.textContent = "Typing...";
      messageList.appendChild(li);
      messageList.scrollTop = messageList.scrollHeight;
    }
  });

  socket.on("stop typing", () => {
    const li = document.getElementById("typing");
    if (li) li.remove();
  });

  // ---------- HELPERS ----------
  function getDayString(date){
    const today = new Date(), yesterday = new Date(); yesterday.setDate(today.getDate()-1);
    if(date.toDateString()===today.toDateString()) return "Today";
    if(date.toDateString()===yesterday.toDateString()) return "Yesterday";
    return date.toLocaleDateString();
  }

  function appendMessage(msg, scroll = true){
    const msgDate = new Date(msg.createdAt);
    const dayStr = getDayString(msgDate);
    if(dayStr !== lastDateStr){
      const separator = document.createElement("li");
      separator.className = "day-separator";
      separator.textContent = dayStr;
      messageList.appendChild(separator);
      lastDateStr = dayStr;
    }

    const li = document.createElement("li");
    li.className = "message " + (msg.sender._id===myUserId?"sent":"received");

    let contentHtml = msg.content || "";
    if(msg.fileType==="image" && msg.fileUrl) contentHtml += `<img src="${msg.fileUrl}" onclick="showModal(this.src)">`;
    if(msg.fileType==="file" && msg.fileUrl) contentHtml += `<a href="${msg.fileUrl}" target="_blank">File</a>`;
    contentHtml += `<div class="timestamp">${msgDate.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}</div>`;
    li.innerHTML = contentHtml;
    messageList.appendChild(li);

    if(scroll) messageList.scrollTop = messageList.scrollHeight;
  }

  // ---------- LOAD OLD MESSAGES ----------
  async function loadMessages(){
    try {
      const res = await fetch(`/api/messages/history/${receiverId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if(data.success){
        data.messages.forEach(msg => appendMessage(msg, false));
        messageList.scrollTop = messageList.scrollHeight;
      }
    } catch(err){
      console.error("Failed to load messages:", err);
    }
  }
  loadMessages();

  // ---------- SEND TEXT ----------
  messageForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const content = messageInput.value.trim();
    if(!content) return;

    try {
      const res = await fetch("/api/messages/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ receiverId, content }),
      });
      const data = await res.json();
      if (data.success) {
        appendMessage(data.message);                // show instantly
        socket.emit("private message", data.message); // push to receiver
      }
    } catch (err) {
      console.error("Send message failed:", err);
    }

    messageInput.value = "";
  });

  // ---------- RECEIVE REALTIME ----------
  socket.on("private message", (msg) => {
    console.log("ðŸ“© Incoming:", msg);
    appendMessage(msg);
  });

  // ---------- SEND FILES ----------
  async function sendFiles(files){
    if(!files.length) return;
    for(const f of files){
      const tempMsg = {
        sender: {_id: myUserId},
        content:"",
        fileUrl: URL.createObjectURL(f),
        fileType: f.type.startsWith("image/")?"image":"file",
        createdAt: new Date()
      };
      appendMessage(tempMsg);

      const formData = new FormData();
      formData.append("file", f);
      formData.append("recipient", receiverId);

      try{
        const res = await fetch("/api/messages/file", { method:"POST", headers:{Authorization:`Bearer ${token}`}, body:formData });
        const data = await res.json();
        appendMessage(data);
        socket.emit("private message", data);
      }catch(err){console.error("File upload failed:", err);}
    }
  }

  imageInput.addEventListener("change", e=>sendFiles([...e.target.files]));
  fileInput.addEventListener("change", e=>sendFiles([...e.target.files]));

  // ---------- ONLINE STATUS ----------
  socket.on("connect",()=>onlineStatusEl.textContent="Online");
  socket.on("disconnect",()=>onlineStatusEl.textContent="Offline");

  // ---------- IMAGE MODAL ----------
  window.showModal = src=>{
    modalImg.src=src;
    imageModal.style.display="flex";
  };
  closeModal.addEventListener("click", ()=>imageModal.style.display="none");
  imageModal.addEventListener("click", e=>{if(e.target===imageModal) imageModal.style.display="none"});
});
</script>
</body>
</html>