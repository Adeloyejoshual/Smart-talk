<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartTalk - Private Chat</title>
<style>
  body { font-family: sans-serif; margin: 0; background: #1c1c1c; color: #fff; height: 100vh; display: flex; flex-direction: column; }
  header { background: #111; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
  header h2 { margin: 0; font-size: 1.2rem; }
  header .online { font-size: 0.8rem; color: #0f0; }
  #messageList { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
  li { list-style: none; display: flex; }
  .sent { justify-content: flex-end; }
  .received { justify-content: flex-start; }
  .bubble { border-radius: 1rem; padding: 0.5rem 1rem; max-width: 75%; word-wrap: break-word; }
  .sent .bubble { background: #0d6efd; color: white; border-bottom-right-radius: 0; }
  .received .bubble { background: #444; color: white; border-bottom-left-radius: 0; }
  .bubble img { max-width: 150px; margin-top: 0.5rem; border-radius: 0.5rem; }
  .bubble a { display: block; margin-top: 0.5rem; color: #0d6efd; text-decoration: underline; }
  .bubble .time { font-size: 0.7rem; opacity: 0.7; text-align: right; margin-top: 2px; }
  form { display: flex; padding: 0.5rem; background: #111; position: sticky; bottom: 0; z-index: 10; gap: 0.5rem; }
  input[type="text"] { flex: 1; padding: 0.5rem 1rem; border-radius: 1rem; border: none; }
  input[type="file"] { display: none; }
  button { padding: 0.5rem 1rem; border-radius: 1rem; border: none; background: #0d6efd; color: white; cursor: pointer; }
  .date-separator { text-align: center; opacity: 0.6; margin: 0.5rem 0; font-size: 0.8rem; }
  .typing { font-style: italic; opacity: 0.6; font-size: 0.8rem; }
</style>
</head>
<body>

<header>
  <div>
    <h2 id="chatUser">Chat</h2>
    <div id="onlineStatus" class="online">Offline</div>
  </div>
</header>

<ul id="messageList"></ul>

<form id="messageForm">
  <input type="text" id="messageInput" placeholder="Type a message...">
  <label for="imageInput" style="cursor:pointer;">ðŸ“·</label>
  <input type="file" id="imageInput" accept="image/*" multiple>
  <label for="fileInput" style="cursor:pointer;">ðŸ“Ž</label>
  <input type="file" id="fileInput" multiple>
  <button type="submit">Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io({ auth: { token: localStorage.getItem("token") } });
  const urlParams = new URLSearchParams(window.location.search);
  const receiverId = urlParams.get("user");
  const messageList = document.getElementById("messageList");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const imageInput = document.getElementById("imageInput");
  const fileInput = document.getElementById("fileInput");
  const chatUser = document.getElementById("chatUser");
  const onlineStatus = document.getElementById("onlineStatus");

  if (!receiverId) return window.location.href = "/home.html";

  let myUserId = null;
  let lastDate = "";

  // Get my user id from JWT
  const token = localStorage.getItem("token");
  try {
    myUserId = JSON.parse(atob(token.split('.')[1])).id;
  } catch { window.location.href="/home.html"; }

  // Join private room
  socket.emit("joinPrivateRoom", { sender: myUserId, receiverId });

  // Update online status
  socket.on("userOnline", () => onlineStatus.textContent = "Online");
  socket.on("userOffline", () => onlineStatus.textContent = "Offline");

  // Load chat history
  async function loadMessages() {
    const res = await fetch(`/api/messages/history/${receiverId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    if (!data.success) return;

    messageList.innerHTML = "";
    data.messages.forEach(msg => appendMessage(msg));
    messageList.scrollTop = messageList.scrollHeight;
  }
  loadMessages();

  // Send text message
  messageForm.addEventListener("submit", async e => {
    e.preventDefault();
    const content = messageInput.value.trim();
    if (!content) return;
    socket.emit("private message", { to: receiverId, message: content });
    messageInput.value = "";
  });

  // Send files/images
  async function sendFiles(files) {
    if (!files.length) return;
    const formData = new FormData();
    for (const f of files) formData.append("files", f);
    formData.append("recipient", receiverId);

    const res = await fetch("/api/messages/file", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: formData
    });
    const data = await res.json();
    if (!data) return;
    appendMessage(data);
  }

  imageInput.addEventListener("change", e => sendFiles([...e.target.files]));
  fileInput.addEventListener("change", e => sendFiles([...e.target.files]));

  // Typing indicator
  let typingTimeout;
  messageInput.addEventListener("input", () => {
    socket.emit("typing", { to: receiverId });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => socket.emit("stop typing", { to: receiverId }), 1500);
  });
  const typingIndicator = document.createElement("li");
  typingIndicator.className = "typing";
  typingIndicator.textContent = "Typing...";
  socket.on("typing", () => { if (!messageList.contains(typingIndicator)) messageList.appendChild(typingIndicator); });
  socket.on("stop typing", () => { if (messageList.contains(typingIndicator)) messageList.removeChild(typingIndicator); });

  // Receive new messages
  socket.on("private message", msg => appendMessage(msg));

  // Append message to list
  function appendMessage(msg) {
    const isMine = msg.sender.id === myUserId;
    const msgDate = new Date(msg.createdAt).toDateString();
    if (msgDate !== lastDate) {
      const sep = document.createElement("li");
      sep.className = "date-separator";
      sep.textContent = msgDate;
      messageList.appendChild(sep);
      lastDate = msgDate;
    }

    const li = document.createElement("li");
    li.className = isMine ? "sent" : "received";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `
      ${msg.content || ""}
      ${msg.fileType === "image" && msg.fileUrl ? `<img src="${msg.fileUrl}"/>` : ""}
      ${msg.fileType === "file" && msg.fileUrl ? `<a href="${msg.fileUrl}" target="_blank">File</a>` : ""}
      <div class="time">${new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    li.appendChild(bubble);
    messageList.appendChild(li);
    messageList.scrollTop = messageList.scrollHeight;
  }

});
</script>
</body>
</html>