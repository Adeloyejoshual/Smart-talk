<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartTalk - Private Chat</title>
<style>
  /* Reset & base */
  body, html { margin:0; padding:0; font-family: sans-serif; height:100%; background:#1c1c1c; color:#fff; }
  a { color:#4eaaff; text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Container */
  .chat-wrapper { display:flex; flex-direction:column; height:100vh; }

  /* Header */
  .chat-header { flex:none; padding:15px; background:#111; display:flex; justify-content:space-between; align-items:center; }
  .chat-header .user-info { display:flex; flex-direction:column; }
  .chat-header .user-info .username { font-weight:bold; font-size:1.1em; }
  .chat-header .user-info .status { font-size:0.8em; color:#0f0; }
  
  /* Messages */
  #chatContainer { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:6px; background:#1c1c1c; }
  .message { max-width:75%; padding:8px 12px; border-radius:12px; word-wrap:break-word; position:relative; }
  .sent { align-self:flex-end; background:#007bff; color:#fff; border-top-right-radius:0; }
  .received { align-self:flex-start; background:#2c2c2c; color:#fff; border-top-left-radius:0; }
  .msg-time { font-size:10px; color:#ccc; margin-top:4px; text-align:right; }
  .file-preview-img { max-width:150px; max-height:150px; display:block; margin-top:5px; border-radius:6px; }

  /* Typing indicator */
  #typingIndicator { font-style:italic; color:#888; padding:5px 10px; }

  /* Footer */
  .chat-footer { flex:none; padding:10px; background:#111; display:flex; gap:8px; align-items:center; }
  #chatInput { flex:1; padding:8px 12px; border-radius:20px; border:none; outline:none; }
  #sendBtn { padding:8px 15px; background:#007bff; border:none; border-radius:20px; color:#fff; cursor:pointer; }
  #fileInput { display:none; }
  .file-preview { display:flex; gap:5px; padding:5px 0; overflow-x:auto; }
  .file-preview-item { background:#333; padding:4px 8px; border-radius:6px; font-size:12px; white-space:nowrap; }
</style>
</head>
<body>
<div class="chat-wrapper">
  <!-- Header -->
  <div class="chat-header">
    <div class="user-info">
      <span class="username" id="chatUsername">Friend</span>
      <span class="status" id="userStatus">Offline</span>
    </div>
    <input type="file" id="fileInput" multiple>
    <button id="attachBtn">ðŸ“Ž</button>
  </div>

  <!-- Messages -->
  <div id="chatContainer"></div>
  <div id="typingIndicator"></div>

  <!-- File preview -->
  <div class="file-preview" id="filePreview"></div>

  <!-- Footer -->
  <div class="chat-footer">
    <input type="text" id="chatInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chatContainer = document.getElementById("chatContainer");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const attachBtn = document.getElementById("attachBtn");
const filePreview = document.getElementById("filePreview");
const typingDiv = document.getElementById("typingIndicator");
const usernameEl = document.getElementById("chatUsername");
const statusEl = document.getElementById("userStatus");

const token = localStorage.getItem("token");
const userId = localStorage.getItem("userId");
const urlParams = new URLSearchParams(window.location.search);
const receiverId = urlParams.get("user");
let selectedFiles = [];
let typingTimeout;

// Open file selector
attachBtn.addEventListener("click", () => fileInput.click());

// ----- Display message -----
function displayMessage(sender, content, timestamp, fileUrl="") {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("message");
  msgDiv.classList.add(sender==="me" ? "sent" : "received");

  let html = "";
  if (fileUrl) {
    const ext = fileUrl.split(".").pop();
    if (["png","jpg","jpeg","gif"].includes(ext.toLowerCase())) {
      html += `<img src="${fileUrl}" class="file-preview-img"/>`;
    } else {
      html += `<a href="${fileUrl}" target="_blank">ðŸ“Ž ${ext.toUpperCase()} File</a>`;
    }
  }
  if (content) html += `<span class="msg-text">${content}</span>`;
  html += `<div class="msg-time">${new Date(timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  msgDiv.innerHTML = html;

  chatContainer.appendChild(msgDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ----- File preview before sending -----
fileInput.addEventListener("change", () => {
  selectedFiles = Array.from(fileInput.files);
  filePreview.innerHTML = "";
  selectedFiles.forEach(f => {
    const div = document.createElement("div");
    div.className = "file-preview-item";
    div.textContent = f.name;
    filePreview.appendChild(div);
  });
});

// ----- Load chat history -----
async function loadChat() {
  try {
    const res = await fetch(`/api/messages/history/${receiverId}`, {
      headers:{ "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    chatContainer.innerHTML = "";
    if(data.success && data.messages.length){
      data.messages.reverse().forEach(msg => {
        const sender = msg.sender._id === userId ? "me" : "other";
        displayMessage(sender, msg.content, msg.createdAt, msg.fileUrl || msg.image);
      });
    }
  } catch(err){ console.error(err); }
}
loadChat();

// ----- Send message -----
sendBtn.addEventListener("click", async ()=>{
  const content = chatInput.value.trim();
  if(!content && !selectedFiles.length) return;

  let uploadedFiles = [];
  if(selectedFiles.length){
    const formData = new FormData();
    selectedFiles.forEach(f=>formData.append("files", f));
    const res = await fetch(`/api/messages/private/upload`, {
      method:"POST", body:formData, headers:{ "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    if(data.success) uploadedFiles = data.messages;
    selectedFiles=[]; filePreview.innerHTML="";
  }

  // Send text message
  if(content){
    socket.emit("private message", { senderId:userId, receiverId, content });
    displayMessage("me", content, new Date());
    chatInput.value="";
  }

  // Send files
  uploadedFiles.forEach(msg=>{
    socket.emit("private message", { senderId:userId, receiverId, content:msg.content, fileUrl: msg.file || msg.image });
    displayMessage("me", msg.content, new Date(), msg.file || msg.image);
  });
});

// ----- Socket listeners -----
socket.on("private message", msg => {
  if(msg.senderId===receiverId) displayMessage("other", msg.content, msg.timestamp || msg.createdAt, msg.fileUrl || msg.image);
});

// Typing indicator
chatInput.addEventListener("input", ()=>{
  socket.emit("typing", { senderId:userId, receiverId });
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>typingDiv.innerText="", 1000);
});
socket.on("typing", ({senderId})=>{
  if(senderId===receiverId) typingDiv.innerText="Friend is typing...";
});

// ----- Online status -----
function fetchOnlineStatus(){
  fetch(`/api/users/status/${receiverId}`, { headers:{ "Authorization":`Bearer ${token}` } })
  .then(r=>r.json())
  .then(data=>statusEl.innerText = data.online ? "Online" : "Offline")
  .catch(err=>console.error(err));
}
fetchOnlineStatus();
setInterval(fetchOnlineStatus, 5000);
</script>
</body>
</html>