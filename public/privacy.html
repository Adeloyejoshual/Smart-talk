<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Privacy - SmartTalk</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <div class="max-w-md mx-auto px-4 py-6">

      <h1 class="text-2xl font-bold mb-4">Privacy Settings</h1>

      <!-- Online Status -->
      <div class="flex items-center justify-between mb-3 p-3 border rounded-lg dark:border-gray-700">
        <span>Show Online Status</span>
        <input type="checkbox" id="onlineStatusSwitch" class="toggle-switch">
      </div>

      <!-- Typing Indicator -->
      <div class="flex items-center justify-between mb-3 p-3 border rounded-lg dark:border-gray-700">
        <span>Show When I'm Typing</span>
        <input type="checkbox" id="typingStatusSwitch" class="toggle-switch">
      </div>

      <!-- Disappearing Messages -->
      <div class="flex flex-col mb-3 p-3 border rounded-lg dark:border-gray-700">
        <span>Disappearing Messages</span>
        <div class="flex items-center justify-between mt-2">
          <span>Enable</span>
          <input type="checkbox" id="disappearSwitch" class="toggle-switch">
        </div>
        <div class="mt-2 flex items-center justify-between">
          <span>Default Timer (minutes)</span>
          <input type="number" id="disappearTimer" min="1" max="1440" class="w-20 border rounded-lg p-1 dark:bg-gray-800 dark:text-white">
        </div>
      </div>

      <!-- Blocked Users -->
      <button id="blockedUsersBtn" class="w-full bg-red-500 text-white py-2 rounded-lg mb-3">Blocked Users</button>

      <!-- Delete Account -->
      <button id="deleteAccountBtn" class="w-full bg-gray-800 text-white py-2 rounded-lg">Delete Account</button>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const headers = { Authorization: "Bearer " + token, "Content-Type": "application/json" };

      // Load privacy settings
      async function loadPrivacy() {
        const res = await fetch("/api/users/me", { headers });
        const data = await res.json();

        document.getElementById("onlineStatusSwitch").checked = data.onlineStatus === "online";
        document.getElementById("typingStatusSwitch").checked = data.showTyping || false;
        document.getElementById("disappearSwitch").checked = data.disappearingMessages?.enabled || false;
        document.getElementById("disappearTimer").value = data.disappearingMessages?.timer || 60;
      }

      // Save toggle changes
      document.getElementById("onlineStatusSwitch").addEventListener("change", async e => {
        await fetch("/api/users/settings", {
          method: "PUT",
          headers,
          body: JSON.stringify({ onlineStatus: e.target.checked ? "online" : "offline" }),
        });
      });

      document.getElementById("typingStatusSwitch").addEventListener("change", async e => {
        await fetch("/api/users/settings", {
          method: "PUT",
          headers,
          body: JSON.stringify({ showTyping: e.target.checked }),
        });
      });

      document.getElementById("disappearSwitch").addEventListener("change", async e => {
        const timer = parseInt(document.getElementById("disappearTimer").value) || 60;
        await fetch("/api/users/settings", {
          method: "PUT",
          headers,
          body: JSON.stringify({ disappearingMessages: { enabled: e.target.checked, timer } }),
        });
      });

      document.getElementById("disappearTimer").addEventListener("change", async e => {
        const enabled = document.getElementById("disappearSwitch").checked;
        const timer = parseInt(e.target.value) || 60;
        await fetch("/api/users/settings", {
          method: "PUT",
          headers,
          body: JSON.stringify({ disappearingMessages: { enabled, timer } }),
        });
      });

      // Blocked Users
      document.getElementById("blockedUsersBtn").addEventListener("click", () => {
        window.location.href = "/blocked-users.html"; // or modal
      });

      // Delete Account
      document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
        const confirmDelete = confirm("Are you sure? This will delete all your messages and profile permanently!");
        if (!confirmDelete) return;

        const res = await fetch("/api/users/delete-account", {
          method: "DELETE",
          headers
        });

        if (res.ok) {
          alert("Account deleted successfully.");
          localStorage.removeItem("token");
          window.location.href = "/login.html";
        } else {
          alert("Failed to delete account.");
        }
      });

      loadPrivacy();
    </script>

    <style>
      /* Simple switch styling */
      .toggle-switch {
        width: 40px;
        height: 20px;
        -webkit-appearance: none;
        appearance: none;
        background-color: #ccc;
        outline: none;
        border-radius: 999px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }
      .toggle-switch:checked {
        background-color: #34d399; /* green */
      }
      .toggle-switch::before {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        top: 1px;
        left: 1px;
        background: white;
        transition: 0.3s;
      }
      .toggle-switch:checked::before {
        transform: translateX(20px);
      }
    </style>
  </body>
</html>