<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartTalk – Group Chat</title>
  <link rel="stylesheet" href="styles/chat.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <button id="backBtn">← Back</button>
      <h2 id="groupName">Group Chat</h2>
    </div>

    <ul id="messageList" class="message-list"></ul>

    <form id="messageForm" class="message-form">
      <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>

  <script type="module">
    const token = localStorage.getItem("token");
    const groupId = new URLSearchParams(window.location.search).get("group");

    if (!token || !groupId) {
      window.location.href = "/home.html";
    }

    const socket = io();
    const userId = getMyUserId();
    const messageForm = document.getElementById("messageForm");
    const messageInput = document.getElementById("messageInput");
    const messageList = document.getElementById("messageList");
    const backBtn = document.getElementById("backBtn");

    // Join group room
    socket.emit("join-group", groupId);

    // Load existing messages
    fetch(`/api/messages/group/${groupId}`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => res.json())
      .then(data => {
        data.forEach(msg => appendMessage(msg));
        scrollToBottom();
      });

    // Handle new message form submit
    messageForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const res = await fetch("/api/messages/group", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ groupId, text }),
      });

      const data = await res.json();
      socket.emit("group-message", data);
      messageInput.value = "";
    });

    // On receiving a group message
    socket.on("group-message", (msg) => {
      if (msg.group === groupId) {
        appendMessage(msg);
        scrollToBottom();
      }
    });

    // Go back to home
    backBtn.onclick = () => {
      window.location.href = "/home.html";
    };

    // Append message to UI
    function appendMessage({ sender, text, createdAt }) {
      const isMe = sender._id === userId || sender === userId;
      const li = document.createElement("li");
      li.className = isMe ? "sent" : "received";
      li.innerHTML = `
        <div class="bubble">
          <strong>${isMe ? "You" : sender.username || "User"}</strong>: ${text}
          <div class="meta">${new Date(createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      `;
      messageList.appendChild(li);
    }

    // Scroll to bottom
    function scrollToBottom() {
      messageList.scrollTop = messageList.scrollHeight;
    }

    // Decode JWT
    function getMyUserId() {
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        return payload.id || payload.userId;
      } catch {
        return null;
      }
    }
  </script>
</body>
</html>